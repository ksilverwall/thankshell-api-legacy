<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">SLA Bank Management</a>
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#Navber" aria-controls="Navber" aria-expanded="false" aria-label="ナビゲーションの切替">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="Navber">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item active">
            <a class="nav-link">銀行残高<u><span id=carried>---</span> Selan</u></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link">総発行量<u><span id=published>---</span> Selan</u></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link">総流通量<u><span id=currency>---</span> Selan</u></a>
          </li>
        </ul>
        <ul class="navbar-nav mr-auto">
        </ul>
        <ul class="my-2 my-lg-0">
          <a><span id='user-name'>---</span> さん</a>
          <button type="submit" id="logoutButton" class="btn btn-outline-success my-2 my-sm-0">ログアウト</button>
        </ul>
      </div>
    </nav>

    <div id='admin-only' class="container-fluid" style='display:none'>
      <h1>管理フォーム</h1>

      <div class="card bg-light mb-3" style="max-width: 40rem;">
        <div class="card-header">
	      <h4>Selanを増刷する</h4>
        </div>
        <div class="card-body">
          <form id='publish'>
            <div class="form-group">
              <input id='publish-amount'class="form-control text-right" type="number" name="amount" min="1000" value="1000" />
              <input id='publish-button' class="btn btn-primary" type="button" value="新規発行" />
            </div>
          </form>
          <br/>
          <p class="text-center text-danger" id="publish-message">削除未実装のためご注意ください</p>
        </div>
      </div>

      <div class="card bg-warning mb-3" style="max-width: 40rem;">
        <div class="card-header">
	      <h4>ユーザー(未実装)</h4>
        </div>
        <div class="card-body">
          <a href='https://ap-northeast-1.console.aws.amazon.com/cognito/users/?region=ap-northeast-1#/pool/ap-northeast-1_WEGpvJz9M/details?_k=xuxjha'>ユーザー管理画面(Amazon Cognito)</a>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
	      <h4>Selanを送る</h4>
        </div>
        <div class="card-body">
          <form class="form-horizontal" id="send-selan">
            <div class="row">
              <div class="col form-group">
                <label>送金先</label>
                <input class="form-control" type="text" name="to_account" />
              </div>
              <div class="col form-group">
                <label>金額</label>
                <input class="form-control" type="number" min="1" name="amount" value='1000'/>
              </div>
            </div>
            <div class="row">
              <div class="col-5">
              </div>
              <div class="col-2">
                <input id='send-selan-button' class="btn-block btn-primary" type="button" value="送金" />
              </div>
              <div class="col-5">
              </div>
            </div>
          </form>
          <br/>
          <div class="custom-file">
            <p>同時多重発行問題のため凍結中(要直列化)</p>
            <input id="import-transaction-file" type="file" class="custom-file-input" id="customFile" lang="ja" disabled>
            <label id="import-transaction-label" class="custom-file-label" for="customFile" disabled>ファイル選択...</label>
            <button id=import-transaction-button type="button" class="btn btn-danger" disabled>CSVインポート</button>
          </div>
          <p class="text-center text-danger" id="send-selan-message">送金後の取り消しはできませんのでご注意ください</p>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h4>保有状況</h4>
        </div>
        <div class="card-body">
          <p class="text-center text-danger" id="history-message"></p>
          <table class="table mb-0">
            <thead>
              <tr>
                <th scope="col" class="text-right">アカウント</th>
                <th scope="col" class="text-right">金額(selan)</th>
              </tr>
            </thead>
            <tbody id="carried-list">
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">
          <h4>取引履歴</h4>
        </div>
        <div class="card-body">
          <p class="text-center text-danger" id="history-message"></p>
          <table class="table mb-0">
            <thead>
              <tr>
                <th scope="col" class="text-right">取引ID</th>
                <th scope="col">取引日時</th>
                <th scope="col">FROM</th>
                <th scope="col">TO</th>
                <th scope="col" class="text-right">金額(selan)</th>
              </tr>
            </thead>
            <tbody id="history">
            </tbody>
          </table>
        </div>
      </div>

      <div class="row"></div>
   </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.224.1.min.js"></script>
    <script src="https://s3-ap-northeast-1.amazonaws.com/sla-bank/auth/dist/aws-cognito-sdk.min.js"></script>
    <script src="https://s3-ap-northeast-1.amazonaws.com/sla-bank/auth/dist/amazon-cognito-identity.min.js"></script>
    <script src='https://s3-ap-northeast-1.amazonaws.com/sla-bank/auth/auth.js'></script>
    <script src='https://s3-ap-northeast-1.amazonaws.com/sla-bank/bank.js'></script>

    <script>
      $(function() {
        upsample.checkSession( (err, data) => {
          if(err) {
            console.log(err);
            $(location).attr('href', 'login');
          } else {
            if (!data.session.idToken.payload['cognito:groups'] || data.session.idToken.payload['cognito:groups'].indexOf('admin') === -1) {
                alert('管理者権限がありません。ログインし直すか管理者に問い合わせてください。');
                $(location).attr('href', 'wallet');
            }else{
                $("#user-name").text(data.user ? data.user : '---');
                $("#admin-only").show();
                controller.account = 'sla_bank';
                controller.session = data.session;
                controller.loadTransactions();
                $('#publish-button').click(function(){ controller.publish(); });
                $('#send-selan-button').click(function() { controller.sendSelan(); });
            }
          }
        });
      });

      $('#import-transaction-file').on('change',function(){
        $('#import-transaction-label').html($(this)[0].files[0].name);
      });

      $("#import-transaction-button").click(function(){
        let file = $('#import-transaction-file')[0].files[0];
        var reader = new FileReader();
        reader.readAsText(file);
        reader.addEventListener('load', function() {
          controller.importTransaction(reader.result);
        })
      });

      $('#logoutButton').click(upsample.logout);
    </script>
  </body>
</html>
